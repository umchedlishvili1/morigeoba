<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DutyPlanner Pro - Real-Time Sync</title>
    <style>
        :root { --primary: #4361ee; --dark-red: #8b0000; --bg: #f8f9fd; --sidebar-bg: #1e1e2d; --viber-bg: #7360f2; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        #sidebar { width: 340px; background: var(--sidebar-bg); color: white; padding: 20px; overflow-y: auto; flex-shrink: 0; }
        #main { flex-grow: 1; padding: 20px; overflow-y: auto; background: white; }

        .input-group { margin-bottom: 15px; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; }
        label { display: block; font-size: 12px; margin-bottom: 5px; color: #4361ee; font-weight: bold; }
        input, select { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 10px; border-radius: 6px; width: 100%; box-sizing: border-box; }
        
        .today-box { 
            background: linear-gradient(135deg, #8b0000, #c0392b); 
            color: white; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 30px; 
            box-shadow: 0 10px 20px rgba(139,0,0,0.2);
        }
        .today-name { font-size: 28px; font-weight: 900; margin-bottom: 15px; }

        .btn { padding: 10px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; width: 100%; transition: 0.2s; margin-top: 5px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-copy { background: #2ecc71; color: white; margin-top: 20px; font-size: 16px; height: 50px; }

        .month-header { display: flex; justify-content: space-between; align-items: center; background: #eef2f7; padding: 15px; margin-top: 30px; border-radius: 10px; border-left: 8px solid var(--dark-red); color: #222; }
        .current-time-inline { font-size: 16px; font-weight: 700; color: #d00000; background: white; padding: 5px 10px; border-radius: 5px; border: 1px solid #ddd; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        td { border-bottom: 1px solid #eee; padding: 12px 8px; text-align: left; }
        .weekend { background: #fff5f5; color: #ef233c; }

        .phone-group { display: flex; flex-direction: column; gap: 5px; width: 100%; }
        .btn-call { background: #007bff; color: white !important; text-decoration: none; padding: 8px; border-radius: 6px; font-size: 13px; font-weight: bold; text-align: center; display: block; }
        .btn-viber { background: var(--viber-bg); color: white !important; text-decoration: none; padding: 6px; border-radius: 6px; font-size: 10px; font-weight: 900; text-align: center; display: block; cursor: pointer; }

        .count-badge { background: #4361ee; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-left: 5px; }
        #codeOutput { display: none; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2 style="color:var(--primary); margin-top:0;">DutyPlanner Pro</h2>
    
    <div class="input-group">
        <label>áƒ’áƒáƒœáƒ áƒ˜áƒ’áƒ˜áƒ¡ áƒ¡áƒáƒ—áƒáƒ£áƒ áƒ˜</label>
        <input type="text" id="topTitleInput" placeholder="áƒ›áƒáƒ’: áƒáƒ˜áƒ¢áƒ˜-áƒ¢áƒ”áƒœáƒ¥áƒœáƒ˜áƒ™áƒ£áƒ áƒ˜" oninput="renderPreview()">
    </div>
    
    <div style="display:flex; gap:5px; margin-bottom: 15px;">
        <input type="month" id="startMonth">
        <input type="month" id="endMonth">
    </div>
    <button class="btn btn-primary" style="background:#9b59b6;" onclick="generateRandom()">ğŸ² áƒ’áƒ”áƒœáƒ”áƒ áƒ˜áƒ áƒ”áƒ‘áƒ</button>

    <div class="input-group">
        <label>áƒáƒ”áƒ áƒ¡áƒáƒœáƒáƒšáƒ˜áƒ¡ áƒ‘áƒáƒ–áƒ (áƒ›áƒáƒ áƒ˜áƒ’áƒ”áƒáƒ‘áƒ˜áƒ¡ áƒ áƒáƒáƒ“áƒ”áƒœáƒáƒ‘áƒ)</label>
        <div id="statsUI" style="margin-top:10px; max-height: 200px; overflow-y: auto; font-size:12px; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 5px;"></div>
    </div>

    <button class="btn btn-copy" onclick="copyFinalHTML()">ğŸ“‹ áƒ™áƒáƒ“áƒ˜áƒ¡ áƒ™áƒáƒáƒ˜áƒ áƒ”áƒ‘áƒ</button>
</div>

<div id="main">
    <div id="schedulePreview"></div>
</div>

<textarea id="codeOutput"></textarea>

<script>
    let staff = [
        { name: "áƒ’áƒ˜áƒáƒ áƒ’áƒ˜ áƒšáƒáƒ›áƒ˜áƒ«áƒ”", phone: "555558222" },
        { name: "áƒ¨áƒáƒšáƒ•áƒ áƒ’áƒáƒ’áƒœáƒ˜áƒ«áƒ”", phone: "551770200" },
        { name: "áƒáƒšáƒ˜áƒ™áƒ áƒ§áƒáƒšáƒ˜áƒ©áƒáƒ•áƒ", phone: "551688899" },
        { name: "áƒ•áƒáƒ¡áƒ˜áƒš áƒ’áƒáƒ’áƒáƒšáƒáƒ«áƒ”", phone: "557949827" },
        { name: "áƒ’áƒ˜áƒáƒ áƒ’áƒ˜ áƒ¢áƒáƒ áƒ§áƒáƒ¨áƒ•áƒ˜áƒšáƒ˜", phone: "577385250" },
        { name: "áƒ’áƒ˜áƒáƒ áƒ’áƒ˜ áƒ‘áƒáƒ­áƒáƒ áƒ˜áƒ¨áƒ•áƒ˜áƒšáƒ˜", phone: "591927831" },
        { name: "áƒ’áƒ£áƒ’áƒ áƒ‘áƒáƒšáƒáƒœáƒ©áƒ˜áƒ•áƒáƒ«áƒ”", phone: "577978792" }
    ];
    let admins = [
        { name: "áƒ£áƒ©áƒ áƒ›áƒ­áƒ”áƒ“áƒšáƒ˜áƒ¨áƒ•áƒ˜áƒšáƒ˜", phone: "599470033" },
        { name: "áƒ—áƒ”áƒ›áƒ áƒ’áƒ”áƒšáƒáƒ¨áƒ•áƒ˜áƒšáƒ˜", phone: "577698890" }
    ];

    let currentScheduleData = [];
    const monthsKA = ["áƒ˜áƒáƒœáƒ•áƒáƒ áƒ˜", "áƒ—áƒ”áƒ‘áƒ”áƒ áƒ•áƒáƒšáƒ˜", "áƒ›áƒáƒ áƒ¢áƒ˜", "áƒáƒáƒ áƒ˜áƒšáƒ˜", "áƒ›áƒáƒ˜áƒ¡áƒ˜", "áƒ˜áƒ•áƒœáƒ˜áƒ¡áƒ˜", "áƒ˜áƒ•áƒšáƒ˜áƒ¡áƒ˜", "áƒáƒ’áƒ•áƒ˜áƒ¡áƒ¢áƒ", "áƒ¡áƒ”áƒ¥áƒ¢áƒ”áƒ›áƒ‘áƒ”áƒ áƒ˜", "áƒáƒ¥áƒ¢áƒáƒ›áƒ‘áƒ”áƒ áƒ˜", "áƒœáƒáƒ”áƒ›áƒ‘áƒ”áƒ áƒ˜", "áƒ“áƒ”áƒ™áƒ”áƒ›áƒ‘áƒ”áƒ áƒ˜"];

    function openViber(phone) {
        let clean = phone.toString().replace(/\D/g, '');
        if (clean.length === 9) clean = '995' + clean;
        window.location.href = "viber://contact?number=%2B" + clean;
    }

    function updateStaffUI() { 
        const counts = {};
        currentScheduleData.forEach(d => { counts[d.staffName] = (counts[d.staffName] || 0) + 1; });
        document.getElementById('statsUI').innerHTML = staff.map((s) => {
            const count = counts[s.name] || 0;
            return `<div style="display:flex; justify-content:space-between; margin-bottom:4px;"><span>${s.name}</span><span class="count-badge">${count}</span></div>`;
        }).join(''); 
    }

    function generateRandom() {
        const s = document.getElementById('startMonth').value, e = document.getElementById('endMonth').value;
        if(!s || !e) return alert("áƒáƒ˜áƒ áƒ©áƒ˜áƒ”áƒ— áƒáƒ”áƒ áƒ˜áƒáƒ“áƒ˜!");
        let shuffled = [...staff].sort(() => Math.random() - 0.5);
        let cur = new Date(Date.UTC(s.split('-')[0], s.split('-')[1]-1, 1));
        const end = new Date(Date.UTC(e.split('-')[0], e.split('-')[1], 0));
        currentScheduleData = [];
        let idx = 0;
        while(cur <= end) {
            let p = shuffled[idx % shuffled.length];
            currentScheduleData.push({ 
                day: cur.getUTCDate(), month: cur.getUTCMonth(), year: cur.getUTCFullYear(), 
                isWeekend: (cur.getUTCDay() === 0 || cur.getUTCDay() === 6), 
                staffName: p.name, staffPhone: p.phone 
            });
            idx++; cur.setUTCDate(cur.getUTCDate() + 1);
        }
        updateStaffUI(); renderPreview();
    }

    function renderPreview() {
        const title = document.getElementById('topTitleInput').value || "áƒ¡áƒáƒ›áƒ£áƒ¨áƒáƒ áƒ’áƒáƒœáƒ áƒ˜áƒ’áƒ˜";
        // áƒ“áƒ˜áƒœáƒáƒ›áƒ˜áƒ£áƒ áƒ˜ "áƒ“áƒ¦áƒ”áƒ•áƒáƒœáƒ“áƒ”áƒšáƒ˜" áƒ‘áƒšáƒáƒ™áƒ˜ áƒáƒ áƒ”áƒ•áƒ˜áƒ£áƒ¡áƒ—áƒ•áƒ˜áƒ¡
        let todaySection = `<div id="dynamicToday" class="today-box">áƒ›áƒ£áƒ¨áƒáƒ•áƒ“áƒ”áƒ‘áƒ...</div>`;

        let html = todaySection + `<h1 style="text-align:center; color:var(--dark-red); font-size:22px;">${title}</h1>`;
        let lastMonth = -1;
        
        currentScheduleData.forEach((item, i) => {
            if (item.month !== lastMonth) {
                if (lastMonth !== -1) html += "</tbody></table>";
                html += `<div class="month-header"><b>${monthsKA[item.month]} ${item.year}</b><span class="current-time-inline"></span></div><table class="schedule-table"><tbody>`;
                lastMonth = item.month;
            }
            const options = staff.map(s => `<option value="${s.name}" ${s.name === item.staffName ? 'selected' : ''}>${s.name}</option>`).join('');
            html += `<tr class="${item.isWeekend?'weekend':''}" data-date="${item.year}-${item.month}-${item.day}" data-name="${item.staffName}" data-phone="${item.staffPhone}">
                <td style="width:10%; font-weight:bold;">${item.day}</td>
                <td style="width:45%;"><select onchange="updateStaffManually(${i}, this.value)">${options}</select></td>
                <td style="width:45%;"><div class="phone-group"><a href="tel:${item.staffPhone}" class="btn-call">ğŸ“ ${item.staffPhone}</a><div onclick="openViber('${item.staffPhone}')" class="btn-viber">VIBER</div></div></td>
            </tr>`;
        });

        let adminsHTML = `<div style="text-align:center; margin-top:30px;">${admins.map(a => `<div style="margin-bottom:10px;"><b>${a.name}</b><br><a href="tel:${a.phone}">${a.phone}</a></div>`).join('')}</div>`;
        document.getElementById('schedulePreview').innerHTML = html + "</tbody></table>" + adminsHTML;
        
        // áƒáƒ áƒ”áƒ•áƒ˜áƒ£áƒ¨áƒ˜áƒª áƒ•áƒáƒ›áƒ£áƒ¨áƒáƒ•áƒ”áƒ‘áƒ— áƒ“áƒ¦áƒ”áƒ•áƒáƒœáƒ“áƒ”áƒšáƒ¡
        setTimeout(processTodayLogic, 100); 
    }

    function updateStaffManually(idx, newName) {
        const p = staff.find(s => s.name === newName);
        currentScheduleData[idx].staffName = p.name;
        currentScheduleData[idx].staffPhone = p.phone;
        updateStaffUI();
        renderPreview();
    }

    function processTodayLogic() {
        const now = new Date();
        const d = now.getDate(), m = now.getMonth(), y = now.getFullYear();
        const row = document.querySelector(`tr[data-date="${y}-${m}-${d}"]`);
        const box = document.getElementById('dynamicToday');
        if(row && box) {
            const name = row.getAttribute('data-name');
            const phone = row.getAttribute('data-phone');
            box.innerHTML = `<h2>ğŸ”” áƒ“áƒ¦áƒ”áƒ•áƒáƒœáƒ“áƒ”áƒšáƒ˜ áƒ›áƒáƒ áƒ˜áƒ’áƒ”</h2><div class="today-name">${name}</div><div style="display:flex; gap:10px; justify-content:center;"><a href="tel:${phone}" class="btn-call" style="background:white; color:red !important; width:140px;">ğŸ“ ${phone}</a><div onclick="openViber('${phone}')" class="btn-viber" style="background:white; color:#7360f2 !important; width:100px; line-height:30px;">VIBER</div></div>`;
        } else if(box) {
            box.style.display = 'none';
        }
    }

    function copyFinalHTML() {
        const title = document.getElementById('topTitleInput').value || "áƒ¡áƒáƒ›áƒ£áƒ¨áƒáƒ áƒ’áƒáƒœáƒ áƒ˜áƒ’áƒ˜";
        let tableHTML = "";
        let lastMonth = -1;

        currentScheduleData.forEach((item) => {
            if (item.month !== lastMonth) {
                if (lastMonth !== -1) tableHTML += "</tbody></table>";
                tableHTML += `<div class="month-header"><b>${monthsKA[item.month]} ${item.year}</b><span class="current-time-inline"></span></div><table><tbody>`;
                lastMonth = item.month;
            }
            tableHTML += `<tr class="${item.isWeekend?'weekend':''}" data-d="${item.day}" data-m="${item.month}" data-y="${item.year}" data-n="${item.staffName}" data-p="${item.staffPhone}">
                <td style="width:15%;"><b>${item.day}</b></td>
                <td style="width:45%;"><b>${item.staffName}</b></td>
                <td style="width:40%;"><div class="phone-group"><a href="tel:${item.staffPhone}" class="btn-call">ğŸ“ ${item.staffPhone}</a><div onclick="openViber('${item.staffPhone}')" class="btn-viber">VIBER</div></div></td>
            </tr>`;
        });

        const final = `<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><style>
            body { font-family: sans-serif; background: #f4f7f9; padding: 10px; }
            .container { max-width: 500px; margin: auto; background: white; padding: 15px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
            .today-box { background: linear-gradient(135deg, #8b0000, #c0392b); color: white; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 20px; display:none; }
            .today-name { font-size: 24px; font-weight: 900; margin-bottom: 10px; }
            .month-header { display: flex; justify-content: space-between; align-items: center; background: #eee; padding: 10px; margin-top: 20px; border-radius: 5px; border-left: 5px solid #8b0000; }
            table { width: 100%; border-collapse: collapse; }
            td { padding: 12px 5px; border-bottom: 1px solid #eee; font-size: 14px; }
            .weekend { background: #fff5f5; color: #d9534f; }
            .phone-group { display: flex; flex-direction: column; gap: 4px; }
            .btn-call { background: #007bff; color: white !important; text-decoration: none; padding: 8px; border-radius: 5px; text-align: center; font-weight: bold; font-size: 12px; }
            .btn-viber { background: #7360f2; color: white !important; padding: 6px; border-radius: 5px; text-align: center; font-weight: 900; font-size: 10px; cursor: pointer; }
        </style></head><body>
        <div class="container">
            <div id="todayBanner" class="today-box"></div>
            <h2 style="text-align:center; color:#8b0000;">${title}</h2>
            ${tableHTML}</tbody></table>
        </div>
        <script>
            function openViber(p) { window.location.href = "viber://contact?number=%2B" + (p.replace(/\\D/g, '').length === 9 ? '995'+p.replace(/\\D/g, '') : p.replace(/\\D/g, '')); }
            function update() {
                const now = new Date();
                const d = now.getDate(), m = now.getMonth(), y = now.getFullYear();
                const timeStr = d + " " + ["áƒ˜áƒáƒœáƒ•áƒáƒ áƒ˜", "áƒ—áƒ”áƒ‘áƒ”áƒ áƒ•áƒáƒšáƒ˜", "áƒ›áƒáƒ áƒ¢áƒ˜", "áƒáƒáƒ áƒ˜áƒšáƒ˜", "áƒ›áƒáƒ˜áƒ¡áƒ˜", "áƒ˜áƒ•áƒœáƒ˜áƒ¡áƒ˜", "áƒ˜áƒ•áƒšáƒ˜áƒ¡áƒ˜", "áƒáƒ’áƒ•áƒ˜áƒ¡áƒ¢áƒ", "áƒ¡áƒ”áƒ¥áƒ¢áƒ”áƒ›áƒ‘áƒ”áƒ áƒ˜", "áƒáƒ¥áƒ¢áƒáƒ›áƒ‘áƒ”áƒ áƒ˜", "áƒœáƒáƒ”áƒ›áƒ‘áƒ”áƒ áƒ˜", "áƒ“áƒ”áƒ™áƒ”áƒ›áƒ‘áƒ”áƒ áƒ˜"][m] + " | " + String(now.getHours()).padStart(2,'0') + ":" + String(now.getMinutes()).padStart(2,'0') + ":" + String(now.getSeconds()).padStart(2,'0');
                document.querySelectorAll('.current-time-inline').forEach(el => el.innerHTML = "ğŸ“… " + timeStr);
                
                const row = document.querySelector('tr[data-d="'+d+'"][data-m="'+m+'"][data-y="'+y+'"]');
                if(row) {
                    const banner = document.getElementById('todayBanner');
                    banner.style.display = 'block';
                    banner.innerHTML = "<div>ğŸ”” áƒ“áƒ¦áƒ”áƒ•áƒáƒœáƒ“áƒ”áƒšáƒ˜ áƒ›áƒáƒ áƒ˜áƒ’áƒ”</div><div class='today-name'>" + row.getAttribute('data-n') + "</div><div style='display:flex; gap:10px; justify-content:center;'><a href='tel:" + row.getAttribute('data-p') + "' class='btn-call' style='background:white; color:red!important; width:120px;'>ğŸ“ áƒ“áƒáƒ áƒ”áƒ™áƒ•áƒ</a><div onclick='openViber(\\"" + row.getAttribute('data-p') + "\\")' class='btn-viber' style='background:white; color:#7360f2!important; width:80px; line-height:22px;'>VIBER</div></div>";
                }
            }
            setInterval(update, 1000); update();
        <\/script></body></html>`;
        
        const el = document.getElementById('codeOutput'); el.value = final; el.style.display="block"; el.select(); document.execCommand('copy'); el.style.display="none";
        alert("áƒ“áƒáƒ¡áƒáƒ™áƒáƒáƒ˜áƒ áƒ”áƒ‘áƒ”áƒšáƒ˜ áƒ™áƒáƒ“áƒ˜ áƒ›áƒ–áƒáƒ“áƒáƒ áƒ“áƒ áƒ¨áƒ”áƒœáƒáƒ®áƒ£áƒšáƒ˜áƒ áƒ‘áƒ£áƒ¤áƒ”áƒ áƒ¨áƒ˜!");
    }

    window.onload = () => { updateStaffUI(); renderPreview(); };
</script>
</body>
</html>
